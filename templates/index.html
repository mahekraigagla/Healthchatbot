<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HealthBot - Disease Prediction Assistant</title>
    <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background:#f0f2f5; height:100vh; overflow:hidden; display:flex; justify-content:center; align-items:center; }
    .main-container { width:95%; max-width:1200px; height:90vh; display:flex; border-radius:20px; box-shadow:0 5px 25px rgba(0,0,0,.15); overflow:hidden; background:#fff; }

    .sidebar { width:30%; background: linear-gradient(180deg, #36c, #6a89cc); color:#fff; padding:30px 20px; display:flex; flex-direction:column; justify-content:space-between; }
    .sidebar-header h1 { font-size:1.8rem; font-weight:700; margin-bottom:5px; }
    .sidebar-header p { font-size:1rem; opacity:.9; }
    .sidebar-section { margin-top:40px; flex:1; }
    .sidebar-section h3 { font-size:1.05rem; margin:14px 0 6px; }
    .sidebar-section p { opacity:.95; }
    .start-session { background:rgba(255,255,255,.15); color:#fff; border:0; border-radius:25px; padding:12px 18px; font-size:1rem; cursor:pointer; }

    .chat-area { width:70%; display:flex; flex-direction:column; background:#fff; }
    .chat-header { background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); color:#fff; padding:16px 20px; display:flex; justify-content:space-between; align-items:center; }
    .header-actions { display:flex; gap:10px; align-items:center; }
    .toggle-btn { cursor:pointer; background:#ffffff20; color:#fff; border:1px solid #ffffff30; border-radius:20px; padding:6px 12px; font-size:.9rem; }

    .chat-body { flex:1; padding:20px; overflow-y:auto; background:#f7f7fb; }
    .message { margin:10px 0; padding:12px 14px; border-radius:12px; max-width:75%; line-height:1.5; word-wrap:break-word; }
    .user-message { background:#667eea; color:#fff; margin-left:auto; border-bottom-right-radius:0; }
    .bot-message { background:#e5e5ea; color:#111; border-bottom-left-radius:0; }

    .chips { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip { background:#eef; color:#334; border:1px solid #ccd; padding:6px 10px; border-radius:16px; cursor:pointer; font-size:.9rem; }
    .chip.no { background:#fee; color:#633; border-color:#f6c; }

    .candidates { margin-top:8px; }
    .candidate { background:#fff; border:1px solid #ddd; border-radius:10px; padding:10px; margin:8px 0; }
    .bar { height:6px; background:#eee; border-radius:6px; overflow:hidden; margin-top:6px; }
    .bar > span { display:block; height:100%; background:#667eea; }

    .chat-input { display:flex; align-items:center; padding:14px; background:#f0f0f0; border-top:1px solid #ddd; gap:10px; }
    .chat-input input { flex:1; padding:12px 15px; border:1px solid #ccc; border-radius:25px; font-size:1rem; outline:none; }
    .chat-input button { background:#667eea; color:#fff; border:0; border-radius:25px; padding:12px 20px; font-size:1rem; cursor:pointer; }
    .mic { background:#10b981; }

    /* Autocomplete dropdown */
    .suggest-box { position:relative; }
    .suggest-list { position:absolute; left:0; right:0; top:100%; background:#fff; border:1px solid #ddd; border-radius:10px; z-index:10; overflow:hidden; }
    .suggest-item { padding:8px 10px; cursor:pointer; }
    .suggest-item:hover { background:#f0f0ff; }

    /* Dark mode */
    body.dark { background:#0f1220; color:#e5e7eb; }
    body.dark .main-container { background:#111827; }
    body.dark .sidebar { background: linear-gradient(180deg,#111827,#1f2937); }
    body.dark .chat-header { background: linear-gradient(90deg,#374151,#4b5563); }
    body.dark .chat-body { background:#0f172a; }
    body.dark .bot-message { background:#1f2937; color:#e5e7eb; }
    body.dark .user-message { background:#4f46e5; }
    body.dark .chat-input { background:#111827; border-top-color:#1f2937; }

    body.large-font { font-size:18px; }

    @media (max-width:900px){ .main-container{ flex-direction:column; height:auto;} .sidebar{ width:100%; flex-direction:row; justify-content:space-around; align-items:center;} .chat-area{ width:100%; } }
    </style>
</head>
<body>
  <div class="main-container">
    <div class="sidebar">
      <div>
        <div class="sidebar-header">
          <h1>ü§ñ HealthBot</h1>
          <p>Your AI Health Assistant</p>
        </div>
        <div class="sidebar-section">
          <h3>üë§ Patient</h3>
          <p id="patient-info">Not provided yet</p>
          <h3>üíä Symptoms</h3>
          <p id="symptoms-info">Not provided yet</p>
          <h3>üìç Location</h3>
          <select id="locationSelect" style="width:100%; margin-top:4px; padding:6px 8px; border-radius:8px; border:1px solid #ddd; font-size:.9rem;">
            <option value="">Select your area</option>
            <option value="Marine Lines / South Mumbai">Marine Lines / South Mumbai</option>
            <option value="Peddar Road / South Mumbai">Peddar Road / South Mumbai</option>
            <option value="Charni Road / South Mumbai">Charni Road / South Mumbai</option>
            <option value="Tardeo / South Mumbai">Tardeo / South Mumbai</option>
            <option value="Mumbai Central">Mumbai Central</option>
            <option value="Sion East">Sion East</option>
            <option value="King‚Äôs Circle / Sion">King‚Äôs Circle / Sion</option>
            <option value="Sion West">Sion West</option>
            <option value="Dharavi-Sion Link Road">Dharavi-Sion Link Road</option>
            <option value="Mahim">Mahim</option>
          </select>
          <p id="location-info" style="margin-top:6px;">Not selected</p>
          <h3>üìä Status</h3>
          <p id="status-info">In progress</p>
          <h3 style="margin-top:16px;">üïí Sessions</h3>
          <div id="session-list" style="max-height:160px; overflow-y:auto; margin-top:4px; font-size:.85rem;">
            <p style="opacity:0.8;">No previous sessions</p>
          </div>
        </div>
      </div>
      <button class="start-session" id="resetBtn">üîÑ Start New Session</button>
    </div>

      <div class="chat-area">
        <div class="chat-header">
          <h2>HealthBot - Disease Prediction Assistant</h2>
          <div class="header-actions">
            <select id="langSelect" class="toggle-btn">
              <option value="en">English</option>
              <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
              <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä</option>
            </select>
            <button id="copyLinkBtn" class="toggle-btn">Copy Link</button>
            <button id="emailBtn" class="toggle-btn">Email Report</button>
            <button id="downloadBtn" class="toggle-btn">Download Report</button>
            <button id="darkBtn" class="toggle-btn">Dark Mode</button>
            <button id="fontBtn" class="toggle-btn">A+</button>
          </div>
        </div>

      <div class="chat-body" id="chat">
        <div class="message bot-message" id="greeting">
          <!-- Initial greeting is filled from JS to support multiple languages -->
        </div>
      </div>

                <div class="chat-input">
        <div class="suggest-box" style="flex:1;">
          <input id="input" type="text" placeholder="Type your answer..." />
          <div id="suggest" class="suggest-list" style="display:none;"></div>
                </div>
        <button id="mic" class="mic">üé§</button>
        <button id="send">Send</button>
            </div>
        </div>
        </div>

    <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const suggestBox = document.getElementById('suggest');
    const micBtn = document.getElementById('mic');
    const sessionList = document.getElementById('session-list');

    const state = {
      step:'name',
      name:'',
      age:'',
      gender:'',
      symptoms:[],
      negatives:[],
      lastPrediction:null,
      allSymptoms:[],
      lastSuggestions:[],
      lang:'en',
      location:'',
      lastHospitals:[],
      sessions:[]
    };

    // Simple text dictionary for future multilingual support
    const TEXT = {
      en: {
        greeting: `Hello! üëã I'm HealthBot.<br/>I'm here to help with disease prediction and medical recommendations.<br/>Let's start by getting to know you.<br/><br/><strong>What‚Äôs your name?</strong>`,
        placeholderAnswer: 'Type your answer...',
        placeholderSymptoms: 'e.g., headache, fever, nausea',
        nameFollowup: (name)=>`Nice to meet you, <strong>${name}</strong>! üéâ<br/><br/>How old are you?`,
        askGender: `Thanks! What's your gender? (Male/Female/Other)`,
        askSymptoms: `Great. Please describe your symptoms (comma-separated or a sentence). You can also click suggestions when I show them.`,
        noneHint: `Type "none of these" to skip these suggestions.`,
        needMoreIntro: `I need a few more details to improve accuracy.`,
        currentCandidates: `Current candidates:`,
        moreQuestion: `Do you have any of these?`,
        predictionTitle: `Most likely condition (not a confirmed diagnosis):`,
        otherNote: `Other possible conditions:`,
        disclaimer: `This is an AI-based estimate and <strong>not</strong> a medical diagnosis. Please consult a licensed doctor for any serious or persistent symptoms.`,
        confidence: (label)=> label === 'high' ? 'High confidence' : (label === 'moderate' ? 'Moderate confidence' : 'Low confidence'),
        reportTitle: 'HealthBot Report',
        reportPredicted: 'Predicted Disease',
        reportDescription: 'Description',
        reportPrecautions: 'Precautions',
        reportMedications: 'Medications',
        reportDiet: 'Diet',
        reportWorkout: 'Workout',
        hospitalsTitle: 'Top nearby hospitals',
        hospitalsNone: 'No hospital data available for your area yet.'
      },
      hi: {
        greeting: `‡§®‡§Æ‡§∏‡•ç‡§§‡•á! üëã ‡§Æ‡•à‡§Ç HealthBot ‡§π‡•Ç‡§Å‡•§<br/>‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•ã ‡§∞‡•ã‡§ó ‡§ï‡•Ä ‡§∏‡§Æ‡•ç‡§≠‡§æ‡§µ‡§®‡§æ ‡§î‡§∞ ‡§Æ‡•á‡§°‡§ø‡§ï‡§≤ ‡§∞‡§ø‡§ï‡§Æ‡•á‡§Ç‡§°‡•á‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶ ‡§ï‡§∞‡•Ç‡§Å‡§ó‡§æ‡•§<br/>‡§∏‡§¨‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§Ü‡§™‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§® ‡§≤‡•á‡§§‡•á ‡§π‡•à‡§Ç‡•§<br/><br/><strong>‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?</strong>`,
        placeholderAnswer: '‡§Ö‡§™‡§®‡§æ ‡§ú‡§µ‡§æ‡§¨ ‡§Ø‡§π‡§æ‡§Å ‡§≤‡§ø‡§ñ‡•á‡§Ç...',
        placeholderSymptoms: '‡§ú‡•à‡§∏‡•á: ‡§∏‡§ø‡§∞‡§¶‡§∞‡•ç‡§¶, ‡§¨‡•Å‡§ñ‡§æ‡§∞, ‡§â‡§≤‡•ç‡§ü‡•Ä',
        nameFollowup: (name)=>`‡§Ü‡§™‡§∏‡•á ‡§Æ‡§ø‡§≤‡§ï‡§∞ ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§≤‡§ó‡§æ, <strong>${name}</strong>! üéâ<br/><br/>‡§Ü‡§™‡§ï‡•Ä ‡§â‡§Æ‡•ç‡§∞ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?`,
        askGender: `‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! ‡§Ü‡§™‡§ï‡§æ ‡§ú‡•á‡§Ç‡§°‡§∞ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à? (Male/Female/Other)`,
        askSymptoms: `‡§Ö‡§ö‡•ç‡§õ‡§æ, ‡§Ö‡§¨ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•á ‡§≤‡§ï‡•ç‡§∑‡§£ (symptoms) ‡§≤‡§ø‡§ñ‡•á‡§Ç (‡§ï‡•â‡§Æ‡§æ ‡§∏‡•á ‡§Ö‡§≤‡§ó ‡§ï‡§∞‡§ï‡•á) ‡§Ø‡§æ ‡§è‡§ï ‡§µ‡§æ‡§ï‡•ç‡§Ø ‡§Æ‡•á‡§Ç ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§ ‡§ú‡§¨ ‡§Æ‡•à‡§Ç ‡§∏‡•Å‡§ù‡§æ‡§µ ‡§¶‡§ø‡§ñ‡§æ‡§ä‡§Å ‡§§‡•ã ‡§Ü‡§™ ‡§â‡§® ‡§™‡§∞ ‡§≠‡•Ä ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§`,
        noneHint: `‡§Ö‡§ó‡§∞ ‡§á‡§®‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§§‡•ã "none of these" ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§`,
        needMoreIntro: `‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§∏‡§π‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡•Å‡§ù‡•á ‡§ï‡•Å‡§õ ‡§î‡§∞ ‡§≤‡§ï‡•ç‡§∑‡§£ ‡§ö‡§æ‡§π‡§ø‡§è‡•§`,
        currentCandidates: `‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§ï‡•Ä ‡§∏‡§Æ‡•ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§¨‡•Ä‡§Æ‡§æ‡§∞‡§ø‡§Ø‡§æ‡§Å:`,
        moreQuestion: `‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™‡§ï‡•ã ‡§á‡§®‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ï‡§ø‡§∏‡•Ä ‡§§‡§∞‡§π ‡§ï‡•á ‡§≤‡§ï‡•ç‡§∑‡§£ ‡§π‡•à‡§Ç?`,
        predictionTitle: `‡§∏‡§¨‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§∏‡§Æ‡•ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø (‡§Ø‡§π ‡§™‡§ï‡•ç‡§ï‡§æ ‡§®‡§ø‡§¶‡§æ‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à):`,
        otherNote: `‡§Ö‡§®‡•ç‡§Ø ‡§∏‡§Æ‡•ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø‡§Ø‡§æ‡§Å:`,
        disclaimer: `‡§Ø‡§π ‡§ï‡•á‡§µ‡§≤ AI ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§® ‡§π‡•à, <strong>‡§Ö‡§∏‡§≤‡•Ä ‡§Æ‡•á‡§°‡§ø‡§ï‡§≤ ‡§°‡§æ‡§Ø‡§ó‡•ç‡§®‡•ã‡§∏‡§ø‡§∏ ‡§®‡§π‡•Ä‡§Ç</strong>‡•§ ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§Ø‡§æ ‡§≤‡§Ç‡§¨‡•á ‡§∏‡§Æ‡§Ø ‡§§‡§ï ‡§∞‡§π‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§≤‡§ï‡•ç‡§∑‡§£‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§Ö‡§µ‡§∂‡•ç‡§Ø ‡§Æ‡§ø‡§≤‡•á‡§Ç‡•§`,
        confidence: (label)=> label === 'high' ? '‡§â‡§ö‡•ç‡§ö ‡§≠‡§∞‡•ã‡§∏‡§æ' : (label === 'moderate' ? '‡§Æ‡§ß‡•ç‡§Ø‡§Æ ‡§≠‡§∞‡•ã‡§∏‡§æ' : '‡§ï‡§Æ ‡§≠‡§∞‡•ã‡§∏‡§æ'),
        reportTitle: 'HealthBot ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü',
        reportPredicted: '‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§∞‡•ã‡§ó',
        reportDescription: '‡§µ‡§ø‡§µ‡§∞‡§£',
        reportPrecautions: '‡§∏‡§æ‡§µ‡§ß‡§æ‡§®‡§ø‡§Ø‡§æ‡§Å',
        reportMedications: '‡§¶‡§µ‡§æ‡§á‡§Ø‡§æ‡§Å',
        reportDiet: '‡§°‡§æ‡§á‡§ü',
        reportWorkout: '‡§µ‡§∞‡•ç‡§ï‡§Ü‡§â‡§ü / ‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ',
        hospitalsTitle: '‡§®‡§ú‡§º‡§¶‡•Ä‡§ï‡•Ä ‡§™‡•ç‡§∞‡§Æ‡•Å‡§ñ ‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤',
        hospitalsNone: '‡§Ü‡§™‡§ï‡•á ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§≠‡•Ä ‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤ ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§'
      },
      mr: {
        greeting: `‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞! üëã ‡§Æ‡•Ä HealthBot ‡§Ü‡§π‡•á.<br/>‡§Æ‡•Ä ‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§≤‡§æ ‡§Ü‡§ú‡§æ‡§∞‡§æ‡§ö‡•Ä ‡§∂‡§ï‡•ç‡§Ø‡§§‡§æ ‡§Ü‡§£‡§ø ‡§µ‡•à‡§¶‡•ç‡§Ø‡§ï‡•Ä‡§Ø ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§¶‡•á‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§Æ‡§¶‡§§ ‡§ï‡§∞‡•á‡§®‡•§<br/>‡§∏‡•Å‡§∞‡•Å‡§µ‡§æ‡§§ ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§ò‡•á‡§ä‡§® ‡§ï‡§∞‡•Ç‡§Ø‡§æ‡•§<br/><br/><strong>‡§§‡•Å‡§Æ‡§ö‡§Ç ‡§®‡§æ‡§µ ‡§ï‡§æ‡§Ø ‡§Ü‡§π‡•á?</strong>`,
        placeholderAnswer: '‡§á‡§•‡•á ‡§§‡•Å‡§Æ‡§ö‡§Ç ‡§â‡§§‡•ç‡§§‡§∞ ‡§≤‡§ø‡§π‡§æ...',
        placeholderSymptoms: '‡§â‡§¶‡§æ.: ‡§°‡•ã‡§ï‡•á‡§¶‡•Å‡§ñ‡•Ä, ‡§§‡§æ‡§™, ‡§â‡§≤‡§ü‡•Ä',
        nameFollowup: (name)=>`‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§ì‡§≥‡§ñ ‡§ï‡§∞‡•Ç‡§® ‡§Ü‡§®‡§Ç‡§¶ ‡§ù‡§æ‡§≤‡§æ, <strong>${name}</strong>! üéâ<br/><br/>‡§§‡•Å‡§Æ‡§ö‡•á ‡§µ‡§Ø ‡§ï‡§ø‡§§‡•Ä ‡§Ü‡§π‡•á?`,
        askGender: `‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! ‡§§‡•Å‡§Æ‡§ö‡•á ‡§≤‡§ø‡§Ç‡§ó ‡§ï‡§æ‡§Ø ‡§Ü‡§π‡•á? (Male/Female/Other)`,
        askSymptoms: `‡§õ‡§æ‡§®. ‡§Ü‡§§‡§æ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§≤‡§ï‡•ç‡§∑‡§£‡•á (symptoms) ‡§≤‡§ø‡§π‡§æ (‡§∏‡•ç‡§µ‡§≤‡•ç‡§™‡§µ‡§ø‡§∞‡§æ‡§Æ‡§æ‡§Ç‡§®‡•Ä ‡§µ‡•á‡§ó‡§≥‡•Ä ‡§ï‡§∞‡•Ç‡§®) ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§è‡§ï‡§æ ‡§µ‡§æ‡§ï‡•ç‡§Ø‡§æ‡§§ ‡§≤‡§ø‡§π‡§æ. ‡§Æ‡•Ä ‡§ú‡•á‡§µ‡•ç‡§π‡§æ ‡§∏‡•Å‡§ö‡§®‡§æ ‡§¶‡§æ‡§ñ‡§µ‡•á‡§® ‡§§‡•á‡§µ‡•ç‡§π‡§æ ‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§§‡•ç‡§Ø‡§æ‡§µ‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•Ç ‡§∂‡§ï‡§§‡§æ‡•§`,
        noneHint: `‡§ú‡§∞ ‡§Ø‡§æ‡§™‡•à‡§ï‡•Ä ‡§ï‡§æ‡§π‡•Ä‡§ö ‡§®‡§∏‡•á‡§≤ ‡§§‡§∞ "none of these" ‡§Ö‡§∏‡•á ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡§æ‡•§`,
        needMoreIntro: `‡§ú‡§æ‡§∏‡•ç‡§§ ‡§Ö‡§ö‡•Ç‡§ï ‡§Ö‡§Ç‡§¶‡§æ‡§ú‡§æ‡§∏‡§æ‡§†‡•Ä ‡§Æ‡§≤‡§æ ‡§Ö‡§ú‡•Ç‡§® ‡§ï‡§æ‡§π‡•Ä ‡§≤‡§ï‡•ç‡§∑‡§£‡§æ‡§Ç‡§ö‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§π‡§µ‡•Ä ‡§Ü‡§π‡•á‡•§`,
        currentCandidates: `‡§Ü‡§§‡§æ‡§™‡§∞‡•ç‡§Ø‡§Ç‡§§‡§ö‡•Ä ‡§∏‡§Ç‡§≠‡§æ‡§µ‡•ç‡§Ø ‡§Ü‡§ú‡§æ‡§∞‡•á:`,
        moreQuestion: `‡§Ø‡§æ‡§™‡•à‡§ï‡•Ä ‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§≤‡§æ ‡§ï‡§æ‡§π‡•Ä ‡§≤‡§ï‡•ç‡§∑‡§£‡•á ‡§Ü‡§π‡•á‡§§ ‡§ï‡§æ?`,
        predictionTitle: `‡§∏‡§∞‡•ç‡§µ‡§æ‡§§ ‡§∏‡§Ç‡§≠‡§æ‡§µ‡•ç‡§Ø ‡§∏‡•ç‡§•‡§ø‡§§‡•Ä (‡§π‡§æ ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§®‡§ø‡§¶‡§æ‡§® ‡§®‡§æ‡§π‡•Ä):`,
        otherNote: `‡§á‡§§‡§∞ ‡§∏‡§Ç‡§≠‡§æ‡§µ‡•ç‡§Ø ‡§∏‡•ç‡§•‡§ø‡§§‡•Ä:`,
        disclaimer: `‡§π‡§æ ‡§´‡§ï‡•ç‡§§ AI ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§Ö‡§Ç‡§¶‡§æ‡§ú ‡§Ü‡§π‡•á, <strong>‡§ñ‡§∞‡§æ ‡§µ‡•à‡§¶‡•ç‡§Ø‡§ï‡•Ä‡§Ø ‡§®‡§ø‡§¶‡§æ‡§® ‡§®‡§æ‡§π‡•Ä</strong>‡•§ ‡§ï‡•ã‡§£‡§§‡•á‡§π‡•Ä ‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§∏‡§§‡§§ ‡§ö‡§æ‡§≤‡§£‡§æ‡§∞‡•á ‡§≤‡§ï‡•ç‡§∑‡§£ ‡§Ö‡§∏‡§≤‡•ç‡§Ø‡§æ‡§∏ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§°‡•â‡§ï‡•ç‡§ü‡§∞‡§æ‡§Ç‡§ö‡§æ ‡§∏‡§≤‡•ç‡§≤‡§æ ‡§ò‡•ç‡§Ø‡§æ‡•§`,
        confidence: (label)=> label === 'high' ? '‡§â‡§ö‡•ç‡§ö ‡§µ‡§ø‡§∂‡•ç‡§µ‡§æ‡§∏' : (label === 'moderate' ? '‡§Æ‡§ß‡•ç‡§Ø‡§Æ ‡§µ‡§ø‡§∂‡•ç‡§µ‡§æ‡§∏' : '‡§ï‡§Æ‡•Ä ‡§µ‡§ø‡§∂‡•ç‡§µ‡§æ‡§∏'),
        reportTitle: 'HealthBot ‡§Ö‡§π‡§µ‡§æ‡§≤',
        reportPredicted: '‡§Ö‡§Ç‡§¶‡§æ‡§ú‡§ø‡§§ ‡§Ü‡§ú‡§æ‡§∞',
        reportDescription: '‡§µ‡§∞‡•ç‡§£‡§®',
        reportPrecautions: '‡§ï‡§æ‡§≥‡§ú‡•Ä / ‡§∏‡§æ‡§µ‡§ß‡§ó‡§ø‡§∞‡•Ä',
        reportMedications: '‡§î‡§∑‡§ß‡•á',
        reportDiet: '‡§Ü‡§π‡§æ‡§∞',
        reportWorkout: '‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ / ‡§µ‡§∞‡•ç‡§ï‡§Ü‡§â‡§ü',
        hospitalsTitle: '‡§ú‡§µ‡§≥‡§ö‡•á ‡§™‡•ç‡§∞‡§Æ‡•Å‡§ñ ‡§∞‡•Å‡§ó‡•ç‡§£‡§æ‡§≤‡§Ø‡•á',
        hospitalsNone: '‡§§‡•Å‡§Æ‡§ö‡•ç‡§Ø‡§æ ‡§™‡§∞‡§ø‡§∏‡§∞‡§æ‡§∏‡§æ‡§†‡•Ä ‡§Ö‡§ú‡•Ç‡§® ‡§∞‡•Å‡§ó‡•ç‡§£‡§æ‡§≤‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä.'
      }
    };

    const SESSIONS_KEY = 'healthbot_sessions_v1';

    // Simple mapping from canonical symptom name (lowercase, spaces) to
    // Hindi / Marathi display labels. Used only for chips; backend still
    // works with English canonical names.
    const SYMPTOM_DISPLAY = {
      "high fever": { hi: "‡§§‡•á‡§ú‡§º ‡§¨‡•Å‡§ñ‡§æ‡§∞", mr: "‡§ú‡•ã‡§∞‡§æ‡§ö‡§æ ‡§§‡§æ‡§™" },
      "mild fever": { hi: "‡§π‡§≤‡•ç‡§ï‡§æ ‡§¨‡•Å‡§ñ‡§æ‡§∞", mr: "‡§π‡§≤‡§ï‡§æ ‡§§‡§æ‡§™" },
      "headache": { hi: "‡§∏‡§∞‡§¶‡§∞‡•ç‡§¶", mr: "‡§°‡•ã‡§ï‡•á‡§¶‡•Å‡§ñ‡•Ä" },
      "abdominal pain": { hi: "‡§™‡•á‡§ü ‡§¶‡§∞‡•ç‡§¶", mr: "‡§™‡•ã‡§ü‡§¶‡•Å‡§ñ‡•Ä" },
      "stomach pain": { hi: "‡§™‡•á‡§ü ‡§¶‡§∞‡•ç‡§¶", mr: "‡§™‡•ã‡§ü‡§¶‡•Å‡§ñ‡•Ä" },
      "nausea": { hi: "‡§Æ‡§§‡§≤‡•Ä", mr: "‡§Æ‡§≥‡§Æ‡§≥" },
      "vomiting": { hi: "‡§â‡§≤‡•ç‡§ü‡•Ä", mr: "‡§ì‡§ï‡§æ‡§±‡•ç‡§Ø‡§æ" },
      "cough": { hi: "‡§ñ‡§æ‡§Ç‡§∏‡•Ä", mr: "‡§ñ‡•ã‡§ï‡§≤‡§æ" },
      "runny nose": { hi: "‡§®‡§æ‡§ï ‡§¨‡§π‡§®‡§æ", mr: "‡§®‡§æ‡§ï ‡§µ‡§æ‡§π‡§£‡•á" },
      "chest pain": { hi: "‡§õ‡§æ‡§§‡•Ä ‡§Æ‡•á‡§Ç ‡§¶‡§∞‡•ç‡§¶", mr: "‡§õ‡§æ‡§§‡•Ä‡§§ ‡§µ‡•á‡§¶‡§®‡§æ" },
      "yellowing of eyes": { hi: "‡§Ü‡§Å‡§ñ‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§™‡•Ä‡§≤‡§æ‡§™‡§®", mr: "‡§°‡•ã‡§≥‡•ç‡§Ø‡§æ‡§Ç‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§™‡§ø‡§µ‡§≥‡•á‡§™‡§£‡§æ" },
      "yellowish skin": { hi: "‡§§‡•ç‡§µ‡§ö‡§æ ‡§Æ‡•á‡§Ç ‡§™‡•Ä‡§≤‡§æ‡§™‡§®", mr: "‡§§‡•ç‡§µ‡§ö‡•á‡§§ ‡§™‡§ø‡§µ‡§≥‡•á‡§™‡§£‡§æ" },
      "burning micturition": { hi: "‡§™‡•á‡§∂‡§æ‡§¨ ‡§Æ‡•á‡§Ç ‡§ú‡§≤‡§®", mr: "‡§≤‡§ò‡§µ‡•Ä ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§ú‡§≥‡§ú‡§≥" },
      "spotting  urination": { hi: "‡§™‡•á‡§∂‡§æ‡§¨ ‡§Æ‡•á‡§Ç ‡§ß‡§¨‡•ç‡§¨‡•á", mr: "‡§≤‡§ò‡§µ‡•Ä‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§°‡§æ‡§ó" },
      "fatigue": { hi: "‡§•‡§ï‡§æ‡§®", mr: "‡§¶‡§Æ ‡§≤‡§æ‡§ó‡§£‡•á" },
      "malaise": { hi: "‡§Ö‡§∏‡•ç‡§µ‡§∏‡•ç‡§•‡§§‡§æ", mr: "‡§Ö‡§∏‡•ç‡§µ‡§∏‡•ç‡§•‡§§‡§æ" }
    };

    function symptomLabel(symptomCanonical){
      const lang = state.lang || 'en';
      const pretty = symptomCanonical.replace(/_/g,' ');
      if(lang === 'en') return pretty;
      const map = SYMPTOM_DISPLAY[pretty.toLowerCase()];
      if(!map || !map[lang]) return pretty;
      return `${map[lang]} (${pretty})`;
    }

    // Static hospital directory for supported locations
    const HOSPITALS = {
      "Marine Lines / South Mumbai": [
        {
          name: "Bombay Hospital & Medical Research Centre",
          address: "12 Vitthaldas Thackersey Marg, Marine Lines, Mumbai 400020",
          phone: "+91 22 2206 7676",
          mapsUrl: "https://www.google.com/maps/search/?api=1&query=Bombay+Hospital+%26+Medical+Research+Centre+Marine+Lines+Mumbai"
        },
        {
          name: "Saifee Hospital",
          address: "Maharshi Karve Rd, Girgaon, Mumbai 400004",
          phone: "+91 22 6757 0111",
          mapsUrl: "https://www.google.com/maps/search/?api=1&query=Saifee+Hospital+Girgaon+Mumbai"
        }
      ],
      "Peddar Road / South Mumbai": [
        {
          name: "Jaslok Hospital & Research Centre",
          address: "15 Dr Gopalrao Deshmukh Marg, Peddar Rd, Mumbai 400026",
          phone: "+91 99301 92000",
          mapsUrl: "https://www.google.com/maps/search/?api=1&query=Jaslok+Hospital+%26+Research+Centre+Peddar+Road+Mumbai"
        }
      ],
      "Charni Road / South Mumbai": [
        {
          name: "Sir H. N. Reliance Foundation Hospital",
          address: "Raja Ram Mohan Roy Rd, Mumbai 400004",
          phone: "",
          mapsUrl: "https://www.google.com/maps/search/?api=1&query=Sir+H+N+Reliance+Foundation+Hospital+Mumbai"
        }
      ],
      "Tardeo / South Mumbai": [
        {
          name: "Apollo Spectra Hospital Tardeo",
          address: "Famous Cine Labs 156, Tardeo, Mumbai 400034",
          phone: "+91 84484 40991",
          mapsUrl: "https://www.google.com/maps/search/?api=1&query=Apollo+Spectra+Hospital+Tardeo+Mumbai"
        }
      ],
      "Mumbai Central": [
        {
          name: "Wockhardt Hospitals Mumbai Central",
          address: "1877 Dr Anandrao Nair Marg, Mumbai Central 400011",
          phone: "+91 82911 01001",
          mapsUrl: "https://www.google.com/maps/search/?api=1&query=Wockhardt+Hospitals+Mumbai+Central"
        }
      ],
      "Sion East": [
        {
          name: "K.J. Somaiya Hospital & Research Center",
          address: "Somaiya Ayurvihar, Eastern Express Hwy, Sion 400022",
          phone: "+91 22 5095 4700",
          mapsUrl: "https://www.google.com/maps/search/?api=1&query=K+J+Somaiya+Hospital+%26+Research+Center+Sion+Mumbai"
        }
      ],
      "King‚Äôs Circle / Sion": [
        {
          name: "Smt S R Mehta & Sir K P Cardiac Institute",
          address: "Road 31, King‚Äôs Circle, Sion East, Mumbai 400022",
          phone: "+91 22 6910 5400",
          mapsUrl: "https://www.google.com/maps/search/?api=1&query=Smt+S+R+Mehta+%26+Sir+K+P+Cardiac+Institute+Sion+Mumbai"
        }
      ],
      "Sion West": [
        {
          name: "Lokmanya Tilak Municipal General Hospital",
          address: "Sion West, Mumbai 400022",
          phone: "",
          mapsUrl: "https://www.google.com/maps/search/?api=1&query=Lokmanya+Tilak+Municipal+General+Hospital+Sion+Mumbai"
        }
      ],
      "Dharavi-Sion Link Road": [
        {
          name: "Lifecare Hospital Sion",
          address: "Sion-Bandra Link Rd, Dharavi, Mumbai 400017",
          phone: "+91 82918 54375",
          mapsUrl: "https://www.google.com/maps/search/?api=1&query=Lifecare+Hospital+Sion+Mumbai"
        }
      ],
      "Mahim": [
        {
          name: "Fortis S L Raheja Hospital",
          address: "Raheja Rugnalaya Marg, Mahim West, Mumbai 400016",
          phone: "+91 22 6884 6143",
          mapsUrl: "https://www.google.com/maps/search/?api=1&query=Fortis+S+L+Raheja+Hospital+Mahim+Mumbai"
        }
      ]
    };

    fetch('/symptom_list').then(r=>r.json()).then(list=> state.allSymptoms = list);

    function appendBot(html, speak=false){ const el=document.createElement('div'); el.className='message bot-message'; el.innerHTML=html; chat.appendChild(el); chat.scrollTop=chat.scrollHeight; if(speak){ try{ const u=new SpeechSynthesisUtterance(el.textContent); speechSynthesis.speak(u);}catch(e){} } }
    function appendUser(text){ const el=document.createElement('div'); el.className='message user-message'; el.textContent=text; chat.appendChild(el); chat.scrollTop=chat.scrollHeight; }
    function updateSidebar(){
      const patient = [state.name,state.age,state.gender].filter(Boolean).join(', ')
      document.getElementById('patient-info').textContent = patient || 'Not provided yet';
      const all = state.symptoms.concat(state.negatives.map(n=>'no '+n));
      document.getElementById('symptoms-info').textContent = all.join(', ') || 'Not provided yet';
      document.getElementById('location-info').textContent = state.location || 'Not selected';
    }

    function renderSessions(){
      if(!state.sessions.length){
        sessionList.innerHTML = `<p style="opacity:0.8;">No previous sessions</p>`;
        return;
      }
      sessionList.innerHTML = state.sessions.map(s=>`
        <div class="session-item" data-id="${s.id}" style="padding:6px 8px; margin-bottom:4px; border-radius:8px; background:#ffffff10; border:1px solid #ffffff30; cursor:pointer;">
          <div><strong>${s.title}</strong></div>
          <div style="opacity:0.8;">${s.subtitle}</div>
        </div>
      `).join('');
    }

    function loadSessionsFromStorage(){
      try{
        const raw = localStorage.getItem(SESSIONS_KEY);
        if(raw){
          state.sessions = JSON.parse(raw);
        }
      }catch(e){
        state.sessions = [];
      }
      renderSessions();
    }

    function saveSessionsToStorage(){
      try{
        localStorage.setItem(SESSIONS_KEY, JSON.stringify(state.sessions));
      }catch(e){}
    }

    function persistCurrentSession(){
      if(!state.lastPrediction) return;
      const d = state.lastPrediction;
      const ts = new Date().toLocaleString();
      const id = Date.now().toString();
      const title = d.predicted_disease || 'Session';
      const subtitle = `${state.name||'Anon'} ‚Ä¢ ${ts}`;
      const snapshot = {
        id,
        title,
        subtitle,
        lang: state.lang,
        location: state.location,
        name: state.name,
        age: state.age,
        gender: state.gender,
        symptoms: state.symptoms,
        negatives: state.negatives,
        lastPrediction: d,
        lastHospitals: state.lastHospitals,
        chatHtml: chat.innerHTML
      };
      state.sessions.unshift(snapshot);
      // keep only latest 20
      state.sessions = state.sessions.slice(0,20);
      saveSessionsToStorage();
      renderSessions();
    }

    function loadSessionById(id){
      const s = state.sessions.find(x=>x.id===id);
      if(!s) return;
      state.lang = s.lang || 'en';
      state.location = s.location || '';
      state.name = s.name || '';
      state.age = s.age || '';
      state.gender = s.gender || '';
      state.symptoms = s.symptoms || [];
      state.negatives = s.negatives || [];
      state.lastPrediction = s.lastPrediction || null;
      state.lastHospitals = s.lastHospitals || [];
      state.step = 'symptoms'; // resume at symptoms for safety
      document.getElementById('langSelect').value = state.lang;
      document.getElementById('locationSelect').value = state.location || '';
      updateSidebar();
      chat.innerHTML = s.chatHtml || '';
      document.getElementById('status-info').textContent = 'Loaded previous session';
    }
    function reset(){
      const t = TEXT[state.lang] || TEXT.en;
      chat.innerHTML = `<div class="message bot-message">${t.greeting}</div>`;
      input.placeholder = t.placeholderAnswer;
      input.value='';
      state.step='name'; state.name=''; state.age=''; state.gender=''; state.symptoms=[]; state.negatives=[]; state.lastPrediction=null;
      updateSidebar();
      document.getElementById('status-info').textContent='In progress';
      suggestBox.style.display='none'; suggestBox.innerHTML='';
    }

    document.getElementById('resetBtn').addEventListener('click', reset);

    function chipsHtml(items){
      state.lastSuggestions = items.slice();
      const t = TEXT[state.lang] || TEXT.en;
      return `<div class="chips">${items.map(s=>{
        const label = symptomLabel(s);
        return `<span class="chip" data-yes="${s}">${label}</span>`;
      }).join('')}</div><div style="margin-top:6px;color:#555;font-size:.9rem;">${t.noneHint}</div>`;
    }
    chat.addEventListener('click', async (e)=>{
      const yes=e.target.getAttribute?.('data-yes');
      if(yes){
        state.symptoms.push(yes);
        updateSidebar();
        appendUser(symptomLabel(yes));
        await maybePredict();
      }
    });

    function fuzzySuggest(text, limit=6){ const t=text.toLowerCase(); if(!t) return []; return state.allSymptoms.map(s=>({s,score: similarity(t,s)})).sort((a,b)=>b.score-a.score).slice(0,limit).map(x=>x.s); }
    function similarity(a,b){ // simple token overlap + prefix
      const A=a.split(/\s+/), B=b.split(/\s+/); const setB=new Set(B); let overlap=0; A.forEach(x=>{ if(setB.has(x)) overlap++; }); const pref=b.startsWith(a)?1:0; return overlap + pref + (a && b ? (1-Math.min(1, Math.abs(b.length-a.length)/Math.max(b.length,1)))*0.3:0); }

    function showSuggestions(){
      const t=input.value.trim();
      const key=t.toLowerCase();
      if(["none of these","i have none of these","none","no"].includes(key) && state.lastSuggestions.length){
        // Mark current suggestions as negatives and fetch new ones
        const addNeg = state.lastSuggestions.filter(s=>!state.symptoms.includes(s) && !state.negatives.includes(s));
        if(addNeg.length){ state.negatives = state.negatives.concat(addNeg); updateSidebar(); appendUser(t); input.value=''; state.lastSuggestions=[]; maybePredict(); }
        suggestBox.style.display='none'; suggestBox.innerHTML='';
        return;
      }
      if(!t){ suggestBox.style.display='none'; suggestBox.innerHTML=''; return; }
      const items=fuzzySuggest(t);
      if(!items.length){ suggestBox.style.display='none'; return; }
      suggestBox.innerHTML = items.map(s=>`<div class="suggest-item" data-sugg="${s}">${s}</div>`).join('');
      suggestBox.style.display='block';
    }
    input.addEventListener('input', showSuggestions);
    suggestBox.addEventListener('click', (e)=>{ const s=e.target.getAttribute?.('data-sugg'); if(s){ input.value=s; suggestBox.style.display='none'; }});

    function extractFromParagraph(text){ const lower=text.toLowerCase(); const found=[]; for(const s of state.allSymptoms){ if(lower.includes(s)) found.push(s); } return found; }

    async function maybePredict(){
      document.getElementById('status-info').textContent='Thinking...';
      const res = await fetch('/predict', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: state.name, age: state.age, gender: state.gender, symptoms: state.symptoms.join(','), negatives: state.negatives }) });
      const data = await res.json();
      if(data.error){ appendBot(`‚ùå ${data.error}`); document.getElementById('status-info').textContent='Awaiting input'; return; }

      if(data.need_more){
        document.getElementById('status-info').textContent='Need more symptoms';
        const t = TEXT[state.lang] || TEXT.en;
        let html = `${t.needMoreIntro} ${data.top_k?.length?`<br/><br><strong>${t.currentCandidates}</strong>`:''}`;
        if(data.top_k && data.top_k.length){
          html += `<div class="candidates">${data.top_k.map(c=>`<div class="candidate"><div><strong>${c.disease}</strong> (${(c.prob*100).toFixed(0)}%)</div><div class="bar"><span style="width:${(c.prob*100).toFixed(0)}%"></span></div></div>`).join('')}</div>`;
        }
        if(data.suggested_symptoms && data.suggested_symptoms.length){ html += `<br/><strong>${t.moreQuestion}</strong>${chipsHtml(data.suggested_symptoms)}`; }
        appendBot(html, true);
        return;
      }

      state.lastPrediction = data;
      document.getElementById('status-info').textContent='Prediction complete';
      const t = TEXT[state.lang] || TEXT.en;
      const confText = t.confidence(data.confidence_label || 'low');
      const primary = data.top_k && data.top_k.length ? data.top_k[0] : null;
      const others = data.top_k && data.top_k.length > 1 ? data.top_k.slice(1) : [];
      appendBot(`
        <strong>${t.predictionTitle}</strong><br/>
        ${primary ? `<strong>${primary.disease}</strong> (${(primary.prob*100).toFixed(0)}% ‚Äì ${confText})<br/><br/>` : ''}
        <strong>Description:</strong> ${data.dis_des}<br/><br/>
        <strong>Precautions:</strong> ${data.my_precautions.join(', ')}<br/><br/>
        <strong>Medications:</strong> ${data.medications.join(', ')}<br/><br/>
        <strong>Diet:</strong> ${data.my_diet.join(', ')}<br/><br/>
        <strong>Workout:</strong> ${data.workout.join(', ')}<br/><br/>
        ${others.length ? `<strong>${t.otherNote}</strong><br/>${others.map(c=>`${c.disease} (${(c.prob*100).toFixed(0)}%)`).join(', ')}<br/><br/>` : ''}
        <em>${t.disclaimer}</em>
      `, true);

      // Suggest nearby hospitals based on selected location
      const loc = state.location;
      const hospitals = (loc && HOSPITALS[loc]) ? HOSPITALS[loc].slice(0,3) : [];
      state.lastHospitals = hospitals;
      if(hospitals.length){
        let hHtml = `<br/><strong>${t.hospitalsTitle} (${loc}):</strong><br/>`;
        hHtml += hospitals.map(h=>`<div style="margin-top:6px;">
            <strong><a href="${h.mapsUrl||'#'}" target="_blank" rel="noopener noreferrer">${h.name}</a></strong><br/>
            ${h.address}${h.phone?`<br/>üìû ${h.phone}`:''}
          </div>`).join('');
        appendBot(hHtml);
      } else if(loc){
        appendBot(`<em>${t.hospitalsNone}</em>`);
      }

      // Persist this completed prediction as a session
      persistCurrentSession();
    }

    async function handleSend(){
      const text = input.value.trim(); if(!text) return; appendUser(text); input.value=''; suggestBox.style.display='none';
      if(state.step==='name'){
        state.name=text;
        state.step='age';
        updateSidebar();
        const t = TEXT[state.lang] || TEXT.en;
        appendBot(t.nameFollowup(state.name));
        return;
      }
      if(state.step==='age'){
        state.age=text;
        state.step='gender';
        updateSidebar();
        const t = TEXT[state.lang] || TEXT.en;
        appendBot(t.askGender);
        return;
      }
      if(state.step==='gender'){
        state.gender=text;
        state.step='symptoms';
        updateSidebar();
        const t = TEXT[state.lang] || TEXT.en;
        appendBot(t.askSymptoms);
        input.placeholder = t.placeholderSymptoms;
        return;
      }
      if(state.step==='symptoms'){
        const key = text.toLowerCase();
        // Allow user to simply answer "no" (or "none of these") to skip
        // the current suggestion set and treat all suggested symptoms as negatives.
        if(["no","none","none of these","i have none of these","nahi","‡§®‡§π‡•Ä‡§Ç","‡§®‡§æ‡§π‡•Ä"].includes(key) && state.lastSuggestions.length){
          const addNeg = state.lastSuggestions.filter(s=>!state.symptoms.includes(s) && !state.negatives.includes(s));
          if(addNeg.length){
            state.negatives = state.negatives.concat(addNeg);
            updateSidebar();
          }
          state.lastSuggestions = [];
          await maybePredict();
          return;
        }

        const parts = text.includes(',') ? text.split(',').map(s=>s.trim()).filter(Boolean) : extractFromParagraph(text);
        for(const p of parts){ if(!state.symptoms.includes(p)) state.symptoms.push(p); }
        updateSidebar();
        await maybePredict();
        return;
      }
    }

    sendBtn.addEventListener('click', handleSend);
    input.addEventListener('keypress', (e)=>{ if(e.key==='Enter') handleSend(); });

    // Mic input (basic Web Speech API)
    let recognizing=false; let rec;
    try {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(SR){
        rec = new SR();
        rec.lang='en-US';
        rec.onresult=(e)=>{
          const t=e.results[0][0].transcript;
          input.value = input.value ? (input.value+ ' ' + t) : t;
          showSuggestions();
        };
        rec.onend=()=>{ recognizing=false; micBtn.textContent='üé§'; };
      }
    } catch(e){}
    micBtn.addEventListener('click', ()=>{
      if(!rec) return;
      if(recognizing){
        rec.stop();
        recognizing=false;
        micBtn.textContent='üé§';
      } else {
        // Switch recognition language based on current UI language
        if(state.lang === 'hi'){ rec.lang='hi-IN'; }
        else if(state.lang === 'mr'){ rec.lang='mr-IN'; }
        else { rec.lang='en-US'; }
        rec.start();
        recognizing=true;
        micBtn.textContent='‚èπ';
      }
    });

    document.getElementById('darkBtn').addEventListener('click', ()=> document.body.classList.toggle('dark'));
    document.getElementById('fontBtn').addEventListener('click', ()=> document.body.classList.toggle('large-font'));

    document.getElementById('downloadBtn').addEventListener('click', ()=>{
      const d = state.lastPrediction;
      const t = TEXT[state.lang] || TEXT.en;
      const w = window.open('', '_blank');
      const hospitals = state.lastHospitals || [];
      const hospSection = hospitals.length ? `
        <hr/>
        <p><strong>${t.hospitalsTitle} (${state.location||'-'}):</strong></p>
        <ul>
          ${hospitals.map(h=>`<li><strong>${h.name}</strong> ‚Äì ${h.address}${h.phone?` ‚Äì ${h.phone}`:''} ‚Äì ${h.mapsUrl?`<a href="${h.mapsUrl}" target="_blank" rel="noopener noreferrer">Open in Google Maps</a>`:''}</li>`).join('')}
        </ul>` : '';
      const body = `
        <h2>${t.reportTitle}</h2>
        <p><strong>Patient:</strong> ${state.name||'-'} | <strong>Age:</strong> ${state.age||'-'} | <strong>Gender:</strong> ${state.gender||'-'}</p>
        <p><strong>Location:</strong> ${state.location||'-'}</p>
        <p><strong>Symptoms:</strong> ${state.symptoms.concat(state.negatives.map(n=>'no '+n)).join(', ')||'-'}</p>
        ${d?`<hr/><p><strong>${t.reportPredicted}:</strong> ${d.predicted_disease}</p>
        <p><strong>${t.reportDescription}:</strong> ${d.dis_des}</p>
        <p><strong>${t.reportPrecautions}:</strong> ${d.my_precautions.join(', ')}</p>
        <p><strong>${t.reportMedications}:</strong> ${d.medications.join(', ')}</p>
        <p><strong>${t.reportDiet}:</strong> ${d.my_diet.join(', ')}</p>
        <p><strong>${t.reportWorkout}:</strong> ${d.workout.join(', ')}</p>`:''}
        ${hospSection}`;
      w.document.write(`<!DOCTYPE html><html><head><title>Report</title></head><body>${body}</body></html>`);
      w.document.close(); w.focus(); w.print();
    });

    // Copy sharable link (current URL)
    document.getElementById('copyLinkBtn').addEventListener('click', async ()=>{
      const url = window.location.href.split('#')[0];
      try{
        if(navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(url);
          appendBot('üîó Link copied to clipboard.');
        }else{
          prompt('Copy this link:', url);
        }
      }catch(e){
        prompt('Copy this link:', url);
      }
    });

    // Email report via mailto:
    document.getElementById('emailBtn').addEventListener('click', ()=>{
      const d = state.lastPrediction;
      const t = TEXT[state.lang] || TEXT.en;
      if(!d){
        appendBot('Please complete a prediction first so I can prepare a report to email.');
        return;
      }
      const lines = [];
      lines.push('HealthBot Report');
      lines.push('');
      lines.push(`Patient: ${state.name||'-'} | Age: ${state.age||'-'} | Gender: ${state.gender||'-'}`);
      lines.push(`Location: ${state.location||'-'}`);
      lines.push(`Symptoms: ${state.symptoms.concat(state.negatives.map(n=>'no '+n)).join(', ')||'-'}`);
      lines.push('');
      lines.push(`${t.reportPredicted}: ${d.predicted_disease}`);
      lines.push(`${t.reportDescription}: ${d.dis_des}`);
      lines.push(`${t.reportPrecautions}: ${d.my_precautions.join(', ')}`);
      lines.push(`${t.reportMedications}: ${d.medications.join(', ')}`);
      lines.push(`${t.reportDiet}: ${d.my_diet.join(', ')}`);
      lines.push(`${t.reportWorkout}: ${d.workout.join(', ')}`);
      if(state.lastHospitals && state.lastHospitals.length){
        lines.push('');
        lines.push(`${t.hospitalsTitle} (${state.location||'-'}):`);
        state.lastHospitals.forEach(h=>{
          lines.push(`- ${h.name} ‚Äì ${h.address}${h.phone?` ‚Äì ${h.phone}`:''}${h.mapsUrl?` ‚Äì ${h.mapsUrl}`:''}`);
        });
      }
      const subject = encodeURIComponent('HealthBot Report');
      const body = encodeURIComponent(lines.join('\n'));
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    });

    // Language selector
    const langSelect = document.getElementById('langSelect');
    langSelect.value = state.lang;
    langSelect.addEventListener('change', (e)=>{
      state.lang = e.target.value || 'en';
      reset();
    });

    // Location selector
    const locSelect = document.getElementById('locationSelect');
    locSelect.addEventListener('change', (e)=>{
      state.location = e.target.value || '';
      updateSidebar();
    });

    // Load previous sessions (if any) and start a new one
    loadSessionsFromStorage();
    reset();

    // Click handler for session list
    sessionList.addEventListener('click', (e)=>{
      const item = e.target.closest('.session-item');
      if(!item) return;
      const id = item.getAttribute('data-id');
      if(id) loadSessionById(id);
    });
    </script>
</body>
</html>